# 9. 数据库架构图详解

## 📖 这个图讲的是什么？

这个图展示了**数据库的整体架构**，就像房子的地基设计图，告诉我们Android端和后端的数据库是如何设计的，以及它们之间是如何同步的。

## 🏗️ 两套数据库系统

### 1️⃣ Android端数据库（Room SQLite）

**作用**：Android手机上的本地数据库，存储用户的数据

**特点**：
- **本地存储**：数据存在手机里，离线也能用
- **快速响应**：不需要网络，查询速度很快
- **Room框架**：使用Android官方的Room数据库框架

**包含的表**：
- **Event 表**：存储日程数据
- **Subscription 表**：存储订阅的日历源

**简单理解**：这是"手机上的数据库"，就像手机上的本地文件夹，存着你的日程数据。

### 2️⃣ 后端数据库（Django ORM）

**作用**：服务器上的云端数据库，存储所有用户的数据

**特点**：
- **云端存储**：数据存在服务器上，需要网络访问
- **多用户共享**：可以存储多个用户的数据
- **Django ORM**：使用Django的ORM框架管理数据库

**包含的模型**：
- **Event 模型**：存储日程数据
- **Subscription 模型**：存储订阅的日历源
- **User 模型**：存储用户信息

**简单理解**：这是"服务器上的数据库"，就像云盘，存着所有人的数据。

## 🔗 数据同步关系（箭头表示同步）

### Android端与后端的同步

```
Android端 Event 表 ←→ 后端 Event 模型  (通过 RESTful API 同步)
Android端 Subscription 表 ←→ 后端 Subscription 模型  (通过 RESTful API 同步)
```

**简单理解**：就像同步文件，手机上的数据可以通过网络同步到云端，云端的数据也可以同步到手机。

### 后端内部的关系

```
后端 Event 模型 → 后端 Subscription 模型  (subscription_id 外键)
后端 Event 模型 → 后端 User 模型  (user_id 外键)
```

**简单理解**：后端的日程数据会关联到订阅源和用户，就像日程表上有标签，标记着这是哪个用户创建的，来自哪个订阅源。

## 💡 举个例子理解数据库架构

**场景一**：用户添加一个新日程

1. **本地模式**：
   - 用户点击"添加日程"
   - Android端把日程保存到**Event 表**（本地数据库）
   - 界面更新显示新日程

2. **云端模式**：
   - 用户点击"添加日程"
   - Android端把日程保存到**Event 表**（临时保存）
   - 通过网络API同步到后端的**Event 模型**（云端数据库）
   - 云端保存成功后，更新本地的Event 表
   - 界面更新显示新日程

**简单理解**：就像发邮件，你可以先在手机上写好（本地保存），然后发送到服务器（云端保存），服务器保存成功后，手机上也有一个副本。

**场景二**：用户订阅一个日历

1. 用户在Android端点击"订阅日历"
2. 通过网络API获取后端的**Subscription 模型**信息
3. 保存到Android端的**Subscription 表**
4. 获取这个订阅源的所有日程（从后端Event 模型）
5. 批量保存到Android端的**Event 表**

**简单理解**：就像订阅公众号，你先关注（订阅源），然后接收所有文章（日程数据），保存在手机里方便查看。

## 🔄 数据同步的三种模式

### 模式一：只使用本地数据库

```
用户操作 → Android端 Event 表 → 界面更新
```

**特点**：
- 不需要网络
- 数据只在手机上
- 不能跨设备同步

**简单理解**：就像单机游戏，数据只存在手机上。

### 模式二：只使用云端数据库

```
用户操作 → API请求 → 后端 Event 模型 → 云端保存 → 界面更新
```

**特点**：
- 需要网络
- 数据在服务器上
- 可以跨设备同步

**简单理解**：就像在线游戏，数据存在服务器上，换设备也能看到。

### 模式三：本地+云端（混合模式）

```
用户操作 → Android端 Event 表 → API同步 → 后端 Event 模型 → 云端保存
```

**特点**：
- 本地和云端都有数据
- 离线可用，在线可同步
- 最好的体验

**简单理解**：就像云盘+本地文件，手机上有备份，云端也有备份，两者自动同步。

## 📊 数据库设计对比

| 特性 | Android端（Room） | 后端（Django ORM） |
|------|------------------|-------------------|
| 存储位置 | 手机本地 | 服务器云端 |
| 数据库类型 | SQLite | PostgreSQL/SQLite |
| 框架 | Room | Django ORM |
| 用户数据 | 单一用户 | 多用户 |
| 网络需求 | 不需要（本地） | 需要（云端） |
| 同步方式 | 通过API同步 | 提供API接口 |

**简单理解**：
- **Android端**：单机数据库，一个人用
- **后端**：多人数据库，大家共享

## 🎯 为什么要设计两套数据库？

1. **离线可用**：
   - 手机上的本地数据库，没网络也能用
   - 就像离线地图，下载后不需要网络

2. **快速响应**：
   - 本地查询速度快，不需要等待网络
   - 就像本地文件，打开速度快

3. **数据同步**：
   - 支持云端模式，可以跨设备同步
   - 就像云盘，换手机也能看到数据

4. **数据安全**：
   - 本地有备份，云端也有备份
   - 就像重要文件，本地存一份，云端存一份

## 📝 总结

这个图告诉我们数据库的架构：

- **Android端**：手机上的本地数据库（Room SQLite），存储用户的数据
- **后端**：服务器上的云端数据库（Django ORM），存储所有用户的数据
- **数据同步**：通过RESTful API实现本地与云端的数据同步

就像房子和云盘的关系：
- **本地数据库** = 房子里的文件柜（存着自己的东西）
- **云端数据库** = 云盘（存着所有人的东西）
- **API同步** = 快递员（把东西在房子和云盘之间传递）

它们共同构建了一个完整的数据库系统，既保证了离线可用，又支持云端同步！

