# 2. 数据流架构图详解

## 📖 这个图讲的是什么？

这个图展示了**数据在应用中是如何流动的**，就像水在管道中流动一样。它说明了从用户操作开始，数据经过哪些步骤，最终又回到了用户界面。

## 🔍 图中有哪些角色？

- **用户**：使用应用的人
- **UI层**：用户界面，用户看到和操作的页面
- **Repository**：数据仓库，负责管理数据的增删改查
- **Database/API**：数据存储或网络接口，真正存数据的地方
- **Manager**：各种管理器，处理特定功能

## 📊 三个主要流程

### 流程一：日程管理流程

**场景**：用户添加、编辑或删除一个日程

```
用户操作 → UI层 → Repository → Database/API → 返回 → UI层 → 显示给用户
```

**详细步骤**：

1. **用户操作**：用户在界面上点击"添加日程"按钮
2. **UI层接收**：MainActivity 接收到用户的点击事件
3. **调用Repository**：UI层调用 EventRepository 来处理数据
4. **数据存储**：
   - 如果是**本地模式**：直接存到 Room 数据库
   - 如果是**云端模式**：通过 Retrofit 调用后端API
5. **返回结果**：Database/API 返回操作是否成功
6. **更新界面**：Repository 把结果返回给 UI层
7. **刷新显示**：UI层更新界面，让用户看到新数据

**简单理解**：就像寄快递，你把包裹给快递员（UI层），快递员给仓库（Repository），仓库存储（Database），然后告诉你送到了，界面更新显示。

### 流程二：提醒功能流程

**场景**：用户设置一个提醒

```
用户设置 → UI层 → ReminderManager → AlarmManager → 确认设置 → 返回UI
```

**详细步骤**：

1. **用户设置**：用户选择某天某个时间要提醒
2. **UI层**：MainActivity 接收设置
3. **ReminderManager**：提醒管理器处理这个设置
4. **AlarmManager**：调用系统闹钟服务，设置系统级别的闹钟
5. **确认设置**：系统返回设置成功
6. **返回结果**：Manager 告诉 UI层设置成功
7. **UI更新**：界面显示"提醒已设置"

**简单理解**：就像设置手机闹钟，你通过日历应用设置（UI层），应用告诉系统（ReminderManager），系统设置闹钟（AlarmManager），到了时间系统就提醒你。

### 流程三：订阅功能流程

**场景**：用户订阅一个公开日历

```
用户订阅 → UI层 → SubscriptionManager → API获取数据 → 保存数据库 → 更新显示
```

**详细步骤**：

1. **用户订阅**：用户选择要订阅的日历（比如"国家节假日"）
2. **UI层**：SubscriptionsActivity 接收订阅请求
3. **SubscriptionManager**：订阅管理器处理订阅
4. **调用API**：Manager 通过网络API获取订阅日历的所有事件
5. **返回事件列表**：后端返回这个日历的所有日程数据
6. **保存到数据库**：Manager 把这些日程保存到本地数据库
7. **更新日历显示**：Manager 通知 UI层更新
8. **显示订阅的日程**：界面上显示新订阅的日程

**简单理解**：就像订阅微信公众号，你点击订阅（UI层），系统去获取文章（SubscriptionManager → API），文章保存到本地，你就能看到新文章了。

## 💡 为什么要分开看这三个流程？

- **日程管理**：这是核心功能，数据只在本地或云端存储
- **提醒功能**：需要和系统服务打交道（闹钟、通知）
- **订阅功能**：需要先获取外部数据，再存储到本地

## 🔄 数据流的双向性

注意箭头：
- **实线箭头（→）**：表示调用/发送数据
- **虚线箭头（-->）**：表示返回结果/响应

数据是**双向流动**的：
- **请求时**：UI → Repository → Database
- **响应时**：Database → Repository → UI

## 📝 总结

这个图告诉我们：
- **数据从哪里来**：用户的操作
- **数据到哪里去**：经过哪些层级的处理
- **数据如何返回**：处理完成后如何反馈给用户

就像工厂的生产线，原材料（用户输入）经过各个加工环节，最终变成产品（界面显示的数据）！
