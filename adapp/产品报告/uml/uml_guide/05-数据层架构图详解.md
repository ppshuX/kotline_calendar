# 5. 数据层架构图详解

## 📖 这个图讲的是什么？

这个图展示了**数据是如何存储、访问和转换的**，就像图书馆的管理系统，告诉我们书籍（数据）如何分类、存储和借阅。

## 🔍 五个组成部分

### 1️⃣ 数据模型（Data Models）
**作用**：定义数据的结构，就像书籍的分类标准

- **Event**：日程数据模型（包含标题、时间、地点等信息）
- **Subscription**：订阅数据模型（包含订阅的日历信息）

**简单理解**：这是"书籍的格式"，规定了日程和订阅应该包含哪些信息。

### 2️⃣ 数据访问（Data Access）
**作用**：提供访问数据库的接口，就像借书的窗口

- **EventDao**：日程数据访问接口（增删改查日程）
- **SubscriptionDao**：订阅数据访问接口（增删改查订阅）

**简单理解**：这是"图书馆的服务窗口"，你可以通过它来存取数据。

### 3️⃣ 数据存储（Data Storage）
**作用**：真正存放数据的地方，就像图书馆的书库

- **Room Database**：本地数据库（存储复杂的日程和订阅数据）
- **SharedPreferences**：简单配置存储（存储用户的简单设置）

**简单理解**：
- Room Database = "大型书库"（存很多复杂数据）
- SharedPreferences = "小抽屉"（存简单设置）

### 4️⃣ 数据转换（Data Conversion）
**作用**：在不同数据格式之间转换，就像翻译员

- **EventConverter**：数据转换器（把网络数据格式转成本地数据格式）
- **EventRepository**：数据仓库（统一管理数据的增删改查）

**简单理解**：这是"翻译员"，把不同格式的数据转换成统一格式。

### 5️⃣ 网络层（Network Layer）
**作用**：从服务器获取数据，就像从其他图书馆借书

- **CalendarApi**：日历API接口
- **RetrofitClient**：网络请求客户端

**简单理解**：这是"网络通道"，从服务器获取数据。

## 🔗 数据流向（箭头表示依赖关系）

### 数据存储的依赖
```
EventDao → Room Database（需要数据库来存储）
EventDao → Event（需要数据模型来定义结构）

SubscriptionDao → Room Database（需要数据库来存储）
SubscriptionDao → Subscription（需要数据模型来定义结构）
```

**简单理解**：Dao 就像"图书管理员"，需要知道书库（数据库）在哪里，书籍（数据模型）是什么格式。

### 数据转换的依赖
```
EventRepository → EventDao（需要通过Dao访问数据库）
EventRepository → CalendarApi（需要通过API获取网络数据）
EventRepository → EventConverter（需要转换器来转换数据格式）

EventConverter → Event（需要知道数据模型的结构）
```

**简单理解**：Repository 就像一个"总管理室"，它协调 Dao（本地数据）和 API（网络数据），通过 Converter 统一数据格式。

### 网络层的依赖
```
CalendarApi → RetrofitClient（需要网络请求工具）
```

**简单理解**：CalendarApi 需要 RetrofitClient 这个工具来发送网络请求。

## 💡 举个例子理解数据层

**场景一**：保存一个新日程到本地

1. 应用创建一个 **Event** 对象（日程数据模型）
2. 调用 **EventRepository** 保存日程
3. Repository 调用 **EventDao** 来保存
4. EventDao 把 Event 存储到 **Room Database**

**简单理解**：就像把一本书放到书库，先确定书的格式（Event），然后告诉管理员（EventDao），管理员把它放到书库（Room Database）。

**场景二**：从服务器同步日程到本地

1. **EventRepository** 调用 **CalendarApi** 获取云端日程
2. CalendarApi 通过 **RetrofitClient** 从服务器获取数据
3. 服务器返回的数据格式可能不同，需要用 **EventConverter** 转换
4. 转换后的 **Event** 对象通过 **EventDao** 保存到 **Room Database**

**简单理解**：就像从其他图书馆借书，先通过网络通道（CalendarApi）获取，然后用转换器（EventConverter）转换成自己的格式，最后存到自己的书库（Room Database）。

## 🔄 数据的两种模式

### 本地模式
```
用户操作 → Repository → EventDao → Room Database
```

**简单理解**：数据只存在手机上，不联网。

### 云端模式
```
用户操作 → Repository → CalendarApi → RetrofitClient → 服务器
                     ↓
                 同步到本地
                     ↓
            EventDao → Room Database
```

**简单理解**：数据先存到服务器，然后同步到手机。

## 🎯 Repository 的核心作用

Repository 是数据层的"统一入口"：

- **对外**：提供统一的数据访问接口
- **对内**：协调本地数据（Dao）和网络数据（API）
- **转换**：通过 Converter 统一数据格式

**简单理解**：Repository 就像一个"一站式服务中心"，不管你要本地数据还是网络数据，都通过它来获取。

## 💾 两种存储方式的选择

### Room Database（用于复杂数据）
- 日程数据（包含多个字段）
- 订阅数据（包含列表、关系等）

### SharedPreferences（用于简单配置）
- 用户设置（主题、语言等）
- 开关状态（是否开启某个功能）

**简单理解**：重要东西放保险柜（Room），小东西放抽屉（SharedPreferences）。

## 📝 总结

这个图展示了数据的"生命周期"：

1. **定义**：数据模型（Event、Subscription）定义数据结构
2. **存储**：数据存储（Room、SharedPreferences）真正存放数据
3. **访问**：数据访问（Dao）提供存取接口
4. **转换**：数据转换（Converter）统一数据格式
5. **同步**：网络层（API）从服务器获取数据

就像图书馆的完整体系：
- **数据模型** = 书籍分类标准
- **数据存储** = 书库
- **数据访问** = 借书窗口
- **数据转换** = 书籍整理
- **网络层** = 其他图书馆

它们共同确保数据能够安全、高效地存储和管理！
