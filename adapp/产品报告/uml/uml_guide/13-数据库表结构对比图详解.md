# 13. æ•°æ®åº“è¡¨ç»“æ„å¯¹æ¯”å›¾è¯¦è§£

## ğŸ“– è¿™ä¸ªå›¾è®²çš„æ˜¯ä»€ä¹ˆï¼Ÿ

è¿™ä¸ªå›¾å±•ç¤ºäº†**Androidç«¯å’Œåç«¯çš„è¡¨ç»“æ„å¯¹æ¯”**ï¼Œå°±åƒä¸¤ä»½è®¾è®¡å›¾çš„å¯¹æ¯”ï¼Œå‘Šè¯‰æˆ‘ä»¬æ‰‹æœºä¸Šçš„æ•°æ®åº“å’ŒæœåŠ¡å™¨ä¸Šçš„æ•°æ®åº“æœ‰ä»€ä¹ˆç›¸åŒç‚¹ï¼Œæœ‰ä»€ä¹ˆä¸åŒç‚¹ã€‚

## ğŸ” å¯¹æ¯”çš„å†…å®¹

### å¯¹æ¯”çš„ä¸¤ç«¯

- **Androidç«¯è¡¨ç»“æ„**ï¼šæ‰‹æœºä¸Šçš„æ•°æ®åº“è¡¨ï¼ˆRoom SQLiteï¼‰
- **åç«¯è¡¨ç»“æ„**ï¼šæœåŠ¡å™¨ä¸Šçš„æ•°æ®åº“è¡¨ï¼ˆDjango ORMï¼‰

### å¯¹æ¯”çš„ç›®çš„

- **äº†è§£å·®å¼‚**ï¼šçœ‹çœ‹Androidç«¯å’Œåç«¯çš„è¡¨ç»“æ„æœ‰ä»€ä¹ˆä¸åŒ
- **ç†è§£æ˜ å°„**ï¼šçŸ¥é“å¦‚ä½•æŠŠAndroidç«¯çš„æ•°æ®è½¬æ¢æˆåç«¯çš„æ•°æ®
- **åŒæ­¥ç­–ç•¥**ï¼šè®¾è®¡æ•°æ®åŒæ­¥æ–¹æ¡ˆ

## ğŸ“Š è¡¨ç»“æ„å¯¹æ¯”

### Event è¡¨å¯¹æ¯”

#### Androidç«¯ï¼ˆeventsè¡¨ï¼‰

**è¡¨å**ï¼š`events`

**å­—æ®µ**ï¼š
- `id`: Longï¼ˆä¸»é”®ï¼Œè‡ªå¢ï¼‰
- `title`: Stringï¼ˆæ ‡é¢˜ï¼‰
- `description`: Stringï¼ˆæè¿°ï¼‰
- `dateTime`: Longï¼ˆæ—¥æœŸæ—¶é—´ï¼ŒUnixæ—¶é—´æˆ³ï¼Œæ¯«ç§’ï¼‰
- `reminderMinutes`: Intï¼ˆæå‰æé†’åˆ†é’Ÿæ•°ï¼‰
- `subscriptionId`: Long?ï¼ˆè®¢é˜…IDï¼Œå¯ç©ºï¼‰
- `locationName`: Stringï¼ˆåœ°ç‚¹åç§°ï¼‰
- `latitude`: Doubleï¼ˆçº¬åº¦ï¼‰
- `longitude`: Doubleï¼ˆç»åº¦ï¼‰
- `createdAt`: Longï¼ˆåˆ›å»ºæ—¶é—´æˆ³ï¼‰

**ç´¢å¼•**ï¼š
- `idx_events_dateTime`ï¼ˆæ—¥æœŸç´¢å¼•ï¼‰
- `idx_events_subscriptionId`ï¼ˆè®¢é˜…ç´¢å¼•ï¼‰

#### åç«¯ï¼ˆeventsè¡¨ï¼‰

**è¡¨å**ï¼š`events`

**å­—æ®µ**ï¼š
- `id`: BigIntegerï¼ˆä¸»é”®ï¼Œè‡ªå¢ï¼‰
- `title`: CharField(200)ï¼ˆæ ‡é¢˜ï¼Œæœ€å¤§200å­—ç¬¦ï¼‰
- `description`: TextFieldï¼ˆæè¿°ï¼‰
- `start_time`: DateTimeFieldï¼ˆå¼€å§‹æ—¶é—´ï¼ŒDateTimeæ ¼å¼ï¼‰
- `end_time`: DateTimeField?ï¼ˆç»“æŸæ—¶é—´ï¼Œå¯é€‰ï¼‰
- `reminder_minutes`: IntegerFieldï¼ˆæå‰æé†’åˆ†é’Ÿæ•°ï¼‰
- `user_id`: BigInteger?ï¼ˆç”¨æˆ·IDï¼Œå¤–é”®ï¼Œå¯ç©ºï¼‰
- `subscription_id`: BigInteger?ï¼ˆè®¢é˜…IDï¼Œå¤–é”®ï¼Œå¯ç©ºï¼‰
- `location_name`: CharField(200)ï¼ˆåœ°ç‚¹åç§°ï¼‰
- `latitude`: FloatFieldï¼ˆçº¬åº¦ï¼‰
- `longitude`: FloatFieldï¼ˆç»åº¦ï¼‰
- `created_at`: DateTimeFieldï¼ˆåˆ›å»ºæ—¶é—´ï¼‰
- `updated_at`: DateTimeFieldï¼ˆæ›´æ–°æ—¶é—´ï¼‰

**ç´¢å¼•**ï¼š
- `idx_events_start_time`ï¼ˆå¼€å§‹æ—¶é—´ç´¢å¼•ï¼‰
- `idx_events_user_start_time`ï¼ˆç”¨æˆ·+æ—¶é—´è”åˆç´¢å¼•ï¼‰
- `idx_events_subscription_start_time`ï¼ˆè®¢é˜…+æ—¶é—´è”åˆç´¢å¼•ï¼‰

#### ä¸»è¦å·®å¼‚

| å­—æ®µå·®å¼‚ | Androidç«¯ | åç«¯ | è¯´æ˜ |
|---------|----------|------|------|
| ä¸»é”®ç±»å‹ | Long | BigInteger | éƒ½æ˜¯æ•´æ•°ç±»å‹ï¼Œåªæ˜¯åç§°ä¸åŒ |
| æ—¶é—´å­—æ®µ | dateTime (Long) | start_time (DateTime) | Androidç”¨æ—¶é—´æˆ³ï¼Œåç«¯ç”¨DateTime |
| ç»“æŸæ—¶é—´ | æ—  | end_time | åç«¯æ”¯æŒç»“æŸæ—¶é—´ |
| ç”¨æˆ·å­—æ®µ | æ—  | user_id | åç«¯éœ€è¦è®°å½•åˆ›å»ºè€… |
| æ›´æ–°æ—¶é—´ | æ—  | updated_at | åç«¯è®°å½•æœ€åæ›´æ–°æ—¶é—´ |
| å­—æ®µå‘½å | é©¼å³°å‘½å | ä¸‹åˆ’çº¿å‘½å | Androidç”¨é©¼å³°ï¼Œåç«¯ç”¨ä¸‹åˆ’çº¿ |

**ç®€å•ç†è§£**ï¼š
- **ç›¸åŒç‚¹**ï¼šéƒ½æœ‰æ ‡é¢˜ã€æè¿°ã€æ—¶é—´ã€åœ°ç‚¹ç­‰åŸºæœ¬å­—æ®µ
- **ä¸åŒç‚¹**ï¼šAndroidç«¯ç”¨æ—¶é—´æˆ³ï¼Œåç«¯ç”¨DateTimeï¼›åç«¯å¤šäº†ç”¨æˆ·å’Œæ›´æ–°æ—¶é—´å­—æ®µ

### Subscription è¡¨å¯¹æ¯”

#### Androidç«¯ï¼ˆsubscriptionsè¡¨ï¼‰

**å­—æ®µ**ï¼š
- `id`: Longï¼ˆä¸»é”®ï¼‰
- `name`: Stringï¼ˆè®¢é˜…åç§°ï¼‰
- `slug`: Stringï¼ˆåç«¯æ ‡è¯†ï¼‰
- `description`: Stringï¼ˆæè¿°ï¼‰
- `color`: Stringï¼ˆæ˜¾ç¤ºé¢œè‰²ï¼‰
- `icon`: Stringï¼ˆå›¾æ ‡emojiï¼‰
- `isEnabled`: Booleanï¼ˆæ˜¯å¦å¯ç”¨ï¼‰
- `eventCount`: Intï¼ˆäº‹ä»¶æ•°é‡ï¼‰
- `lastSyncTime`: Longï¼ˆæœ€ååŒæ­¥æ—¶é—´ï¼‰
- `createdAt`: Longï¼ˆåˆ›å»ºæ—¶é—´ï¼‰

#### åç«¯ï¼ˆsubscriptionsè¡¨ï¼‰

**å­—æ®µ**ï¼š
- `id`: BigIntegerï¼ˆä¸»é”®ï¼‰
- `name`: CharField(100)ï¼ˆè®¢é˜…åç§°ï¼‰
- `slug`: SlugFieldï¼ˆå”¯ä¸€æ ‡è¯†ï¼‰
- `description`: TextFieldï¼ˆæè¿°ï¼‰
- `color`: CharField(7)ï¼ˆæ˜¾ç¤ºé¢œè‰²ï¼‰
- `icon`: CharField(10)ï¼ˆå›¾æ ‡emojiï¼‰
- `is_public`: BooleanFieldï¼ˆæ˜¯å¦å…¬å¼€ï¼‰
- `is_active`: BooleanFieldï¼ˆæ˜¯å¦æ¿€æ´»ï¼‰
- `event_count`: IntegerFieldï¼ˆäº‹ä»¶æ•°é‡ï¼‰
- `subscriber_count`: IntegerFieldï¼ˆè®¢é˜…è€…æ•°é‡ï¼‰
- `created_at`: DateTimeFieldï¼ˆåˆ›å»ºæ—¶é—´ï¼‰
- `updated_at`: DateTimeFieldï¼ˆæ›´æ–°æ—¶é—´ï¼‰

#### ä¸»è¦å·®å¼‚

| å­—æ®µå·®å¼‚ | Androidç«¯ | åç«¯ | è¯´æ˜ |
|---------|----------|------|------|
| å¯ç”¨å­—æ®µ | isEnabled | is_public + is_active | åç«¯åˆ†å¾—æ›´ç»† |
| è®¢é˜…è€…æ•°é‡ | æ—  | subscriber_count | åç«¯éœ€è¦ç»Ÿè®¡è®¢é˜…è€… |
| æœ€ååŒæ­¥æ—¶é—´ | lastSyncTime | æ—  | Androidç«¯éœ€è¦è®°å½•åŒæ­¥æ—¶é—´ |
| æ›´æ–°æ—¶é—´ | æ—  | updated_at | åç«¯è®°å½•æ›´æ–°æ—¶é—´ |

**ç®€å•ç†è§£**ï¼š
- **ç›¸åŒç‚¹**ï¼šéƒ½æœ‰åç§°ã€æ ‡è¯†ã€é¢œè‰²ã€å›¾æ ‡ç­‰åŸºæœ¬å­—æ®µ
- **ä¸åŒç‚¹**ï¼šAndroidç«¯å…³æ³¨åŒæ­¥æ—¶é—´ï¼Œåç«¯å…³æ³¨å…¬å¼€æ€§å’Œè®¢é˜…è€…æ•°é‡

## ğŸ”„ å­—æ®µæ˜ å°„å…³ç³»

### Event è¡¨çš„å­—æ®µæ˜ å°„

```
Androidç«¯å­—æ®µ          â†’    åç«¯å­—æ®µ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
id                   â†’    id
title                â†’    title
description          â†’    description
dateTime (Long)      â†’    start_time (DateTime)  âš ï¸ éœ€è¦è½¬æ¢
reminderMinutes      â†’    reminder_minutes
subscriptionId       â†’    subscription_id
locationName         â†’    location_name
latitude             â†’    latitude
longitude            â†’    longitude
createdAt (Long)     â†’    created_at (DateTime)  âš ï¸ éœ€è¦è½¬æ¢
æ—                    â†’    user_id               âš ï¸ åç«¯ç‰¹æœ‰
æ—                    â†’    end_time              âš ï¸ åç«¯ç‰¹æœ‰
æ—                    â†’    updated_at            âš ï¸ åç«¯ç‰¹æœ‰
```

**è½¬æ¢ç¤ºä¾‹**ï¼š

```kotlin
// Androidç«¯ â†’ åç«¯
fun Event.toBackendEvent(): BackendEventRequest {
    return BackendEventRequest(
        title = this.title,
        description = this.description,
        start_time = Date(this.dateTime).toISOString(),  // æ—¶é—´æˆ³è½¬DateTime
        reminder_minutes = this.reminderMinutes,
        subscription_id = this.subscriptionId,
        location_name = this.locationName,
        latitude = this.latitude,
        longitude = this.longitude
    )
}

// åç«¯ â†’ Androidç«¯
fun BackendEventResponse.toAndroidEvent(): Event {
    return Event(
        id = this.id,
        title = this.title,
        description = this.description,
        dateTime = Date.parse(this.start_time).time,  // DateTimeè½¬æ—¶é—´æˆ³
        reminderMinutes = this.reminder_minutes,
        subscriptionId = this.subscription_id,
        locationName = this.location_name ?: "",
        latitude = this.latitude ?: 0.0,
        longitude = this.longitude ?: 0.0,
        createdAt = Date.parse(this.created_at).time
    )
}
```

### Subscription è¡¨çš„å­—æ®µæ˜ å°„

```
Androidç«¯å­—æ®µ          â†’    åç«¯å­—æ®µ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
id                   â†’    id
name                 â†’    name
slug                 â†’    slug
description          â†’    description
color                â†’    color
icon                 â†’    icon
isEnabled            â†’    is_active             âš ï¸ å­—æ®µåä¸åŒ
eventCount           â†’    event_count
lastSyncTime         â†’    æ—                     âš ï¸ Androidç«¯ç‰¹æœ‰
createdAt (Long)     â†’    created_at (DateTime) âš ï¸ éœ€è¦è½¬æ¢
æ—                    â†’    is_public             âš ï¸ åç«¯ç‰¹æœ‰
æ—                    â†’    subscriber_count      âš ï¸ åç«¯ç‰¹æœ‰
æ—                    â†’    updated_at            âš ï¸ åç«¯ç‰¹æœ‰
```

**è½¬æ¢ç¤ºä¾‹**ï¼š

```kotlin
// Androidç«¯ â†’ åç«¯
fun Subscription.toBackendSubscription(): BackendSubscriptionRequest {
    return BackendSubscriptionRequest(
        name = this.name,
        slug = this.slug,
        description = this.description,
        color = this.color,
        icon = this.icon,
        is_active = this.isEnabled  // å­—æ®µåä¸åŒ
    )
}

// åç«¯ â†’ Androidç«¯
fun BackendSubscriptionResponse.toAndroidSubscription(): Subscription {
    return Subscription(
        id = this.id,
        name = this.name,
        slug = this.slug,
        description = this.description,
        color = this.color,
        icon = this.icon,
        isEnabled = this.is_active,  // å­—æ®µåä¸åŒ
        eventCount = this.event_count,
        lastSyncTime = System.currentTimeMillis()  // è®°å½•åŒæ­¥æ—¶é—´
    )
}
```

## ğŸ’¡ ä¸¾ä¸ªä¾‹å­ç†è§£å­—æ®µæ˜ å°„

**åœºæ™¯**ï¼šåŒæ­¥ä¸€ä¸ªæ—¥ç¨‹ä»Androidç«¯åˆ°åç«¯

**åŸå§‹æ•°æ®ï¼ˆAndroidç«¯ï¼‰**ï¼š

```kotlin
Event(
    id = 1,
    title = "å›¢é˜Ÿä¼šè®®",
    dateTime = 1702274400000L,  // æ—¶é—´æˆ³ï¼š2024-01-10 14:00:00
    subscriptionId = null
)
```

**è½¬æ¢åï¼ˆåç«¯ï¼‰**ï¼š

```python
{
    "id": 1,
    "title": "å›¢é˜Ÿä¼šè®®",
    "start_time": "2024-01-10T14:00:00",  # DateTimeæ ¼å¼
    "subscription_id": null
}
```

**è½¬æ¢è¦ç‚¹**ï¼š

1. **æ—¶é—´æ ¼å¼è½¬æ¢**ï¼š
   - Androidç«¯ï¼š`dateTime = 1702274400000L`ï¼ˆæ—¶é—´æˆ³ï¼Œæ¯«ç§’ï¼‰
   - åç«¯ï¼š`start_time = "2024-01-10T14:00:00"`ï¼ˆDateTimeå­—ç¬¦ä¸²ï¼‰
   - éœ€è¦è½¬æ¢å‡½æ•°ï¼šæ—¶é—´æˆ³ â†” DateTimeå­—ç¬¦ä¸²

2. **å­—æ®µåè½¬æ¢**ï¼š
   - Androidç«¯ï¼š`subscriptionId`ï¼ˆé©¼å³°å‘½åï¼‰
   - åç«¯ï¼š`subscription_id`ï¼ˆä¸‹åˆ’çº¿å‘½åï¼‰
   - éœ€è¦è½¬æ¢å‡½æ•°ï¼šé©¼å³° â†” ä¸‹åˆ’çº¿

3. **å­—æ®µè¡¥å…¨**ï¼š
   - åç«¯éœ€è¦ `user_id`ï¼ˆå½“å‰ç™»å½•ç”¨æˆ·ï¼‰
   - åç«¯éœ€è¦ `updated_at`ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
   - Androidç«¯ä¸éœ€è¦è¿™äº›å­—æ®µ

**ç®€å•ç†è§£**ï¼šå°±åƒç¿»è¯‘ï¼Œè™½ç„¶æ„æ€ä¸€æ ·ï¼Œä½†è¡¨è¾¾æ–¹å¼ä¸åŒï¼Œéœ€è¦è½¬æ¢å‡½æ•°"ç¿»è¯‘"ã€‚

## ğŸ¯ ä¸ºä»€ä¹ˆè¦è®¾è®¡ä¸åŒçš„è¡¨ç»“æ„ï¼Ÿ

### Androidç«¯çš„è®¾è®¡è€ƒè™‘

1. **æ€§èƒ½ä¼˜åŒ–**ï¼š
   - ä½¿ç”¨æ—¶é—´æˆ³ï¼ˆLongï¼‰å­˜å‚¨æ—¶é—´ï¼Œæ–¹ä¾¿æ’åºå’ŒæŸ¥è¯¢
   - å‡å°‘å­—æ®µæ•°é‡ï¼Œæé«˜æŸ¥è¯¢é€Ÿåº¦

2. **ç¦»çº¿ä¼˜å…ˆ**ï¼š
   - ä¸ä¾èµ–ç”¨æˆ·ä¿¡æ¯ï¼ˆuser_idï¼‰ï¼Œç¦»çº¿ä¹Ÿèƒ½ç”¨
   - è®°å½•åŒæ­¥æ—¶é—´ï¼ˆlastSyncTimeï¼‰ï¼Œä¾¿äºåˆ¤æ–­æ˜¯å¦éœ€è¦åŒæ­¥

### åç«¯çš„è®¾è®¡è€ƒè™‘

1. **å¤šç”¨æˆ·æ”¯æŒ**ï¼š
   - éœ€è¦user_idæ ‡è¯†åˆ›å»ºè€…
   - éœ€è¦is_publicåˆ¤æ–­æ˜¯å¦å…¬å¼€

2. **æ•°æ®å®Œæ•´æ€§**ï¼š
   - ä½¿ç”¨DateTimeæ ¼å¼ï¼Œæ›´è§„èŒƒ
   - è®°å½•æ›´æ–°æ—¶é—´ï¼ˆupdated_atï¼‰ï¼Œä¾¿äºè¿½è¸ª

3. **æ‰©å±•æ€§**ï¼š
   - æ”¯æŒç»“æŸæ—¶é—´ï¼ˆend_timeï¼‰
   - ç»Ÿè®¡è®¢é˜…è€…æ•°é‡ï¼ˆsubscriber_countï¼‰

## ğŸ“Š ç´¢å¼•å¯¹æ¯”

### Androidç«¯ç´¢å¼•

- **idx_events_dateTime**ï¼šåŠ é€Ÿæ—¥æœŸæŸ¥è¯¢
- **idx_events_subscriptionId**ï¼šåŠ é€Ÿè®¢é˜…æ—¥ç¨‹æŸ¥è¯¢

**ç®€å•ç†è§£**ï¼šæ‰‹æœºä¸Šçš„ç´¢å¼•æ¯”è¾ƒç®€å•ï¼Œä¸»è¦ä¼˜åŒ–æ—¥æœŸæŸ¥è¯¢ã€‚

### åç«¯ç´¢å¼•

- **idx_events_start_time**ï¼šåŠ é€Ÿæ—¥æœŸèŒƒå›´æŸ¥è¯¢
- **idx_events_user_start_time**ï¼šåŠ é€Ÿç”¨æˆ·æ—¥ç¨‹æŸ¥è¯¢ï¼ˆè”åˆç´¢å¼•ï¼‰
- **idx_events_subscription_start_time**ï¼šåŠ é€Ÿè®¢é˜…æ—¥ç¨‹æŸ¥è¯¢ï¼ˆè”åˆç´¢å¼•ï¼‰

**ç®€å•ç†è§£**ï¼šæœåŠ¡å™¨ä¸Šçš„ç´¢å¼•æ›´å¤æ‚ï¼Œæ”¯æŒå¤šç”¨æˆ·å’Œå¤šç»´åº¦æŸ¥è¯¢ã€‚

## ğŸ“ æ€»ç»“

è¿™ä¸ªå¯¹æ¯”å›¾å±•ç¤ºäº†Androidç«¯å’Œåç«¯è¡¨ç»“æ„çš„å·®å¼‚ï¼š

- **ç›¸åŒç‚¹**ï¼šéƒ½æœ‰åŸºæœ¬çš„å­—æ®µï¼ˆæ ‡é¢˜ã€æè¿°ã€æ—¶é—´ç­‰ï¼‰
- **ä¸åŒç‚¹**ï¼š
  - **æ—¶é—´æ ¼å¼**ï¼šAndroidç”¨æ—¶é—´æˆ³ï¼Œåç«¯ç”¨DateTime
  - **å­—æ®µå‘½å**ï¼šAndroidç”¨é©¼å³°ï¼Œåç«¯ç”¨ä¸‹åˆ’çº¿
  - **é¢å¤–å­—æ®µ**ï¼šåç«¯å¤šäº†ç”¨æˆ·ã€æ›´æ–°æ—¶é—´ç­‰å­—æ®µ

å°±åƒä¸¤ç§è¯­è¨€çš„è¯å…¸ï¼š
- **ç›¸åŒç‚¹**ï¼šéƒ½æœ‰åŸºæœ¬è¯æ±‡ï¼ˆå¯¹åº”åŸºæœ¬å­—æ®µï¼‰
- **ä¸åŒç‚¹**ï¼šè¯­æ³•ä¸åŒï¼ˆå¯¹åº”å­—æ®µæ ¼å¼ä¸åŒï¼‰ï¼Œéœ€è¦ç¿»è¯‘ï¼ˆå¯¹åº”å­—æ®µè½¬æ¢ï¼‰

é€šè¿‡å­—æ®µæ˜ å°„å’Œè½¬æ¢ï¼Œå®ç°äº†Androidç«¯å’Œåç«¯æ•°æ®çš„æ— ç¼åŒæ­¥ï¼Œæ—¢ä¿è¯äº†æœ¬åœ°å¯ç”¨ï¼Œåˆæ”¯æŒäº‘ç«¯åŒæ­¥ï¼

