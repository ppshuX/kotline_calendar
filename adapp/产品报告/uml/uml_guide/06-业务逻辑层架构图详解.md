# 6. 业务逻辑层架构图详解

## 📖 这个图讲的是什么？

这个图展示了**业务逻辑层的组成**，就像公司各个部门的组织结构图，告诉我们有哪些"部门"（管理器），它们各自负责什么工作，需要哪些支持。

## 🔍 四个组成部分

### 1️⃣ 管理器（Manager）
**作用**：各种功能的管理者，负责处理具体的业务逻辑

- **ReminderManager**：提醒管理器（处理日程提醒）
- **SubscriptionManager**：订阅管理器（处理日历订阅）
- **FestivalSubscriptionManager**：节日订阅管理器（处理节日订阅）
- **HolidayManager**：节假日管理器（处理节假日信息）
- **WeatherManager**：天气管理器（处理天气信息）
- **FortuneManager**：运势管理器（处理运势信息）
- **AIAssistant**：AI助手（处理AI对话）

**简单理解**：这是"各个部门的主管"，每个主管负责一个功能。

### 2️⃣ 数据访问（Data Access）
**作用**：提供访问数据的能力

- **EventRepository**：日程数据仓库
- **EventDao**：日程数据访问接口
- **SubscriptionDao**：订阅数据访问接口

**简单理解**：这是"数据部门"，负责提供数据支持。

### 3️⃣ 网络服务（Network Service）
**作用**：提供网络通信能力

- **CalendarApi**：日历API接口

**简单理解**：这是"通信部门"，负责和服务器通信。

### 4️⃣ 系统服务（System Service）
**作用**：系统提供的服务

- **AlarmManager**：系统闹钟服务
- **SharedPreferences**：系统配置存储服务

**简单理解**：这是"外部资源"，需要借用系统的能力。

## 🔗 依赖关系（箭头表示谁需要谁）

### ReminderManager（提醒管理器）的依赖
```
ReminderManager → AlarmManager（需要系统闹钟服务）
ReminderManager → EventDao（需要读取日程数据来设置提醒）
```

**简单理解**：提醒管理器需要从数据库读取日程，然后告诉系统在指定时间提醒用户。

### SubscriptionManager（订阅管理器）的依赖
```
SubscriptionManager → CalendarApi（需要从服务器获取订阅数据）
SubscriptionManager → SubscriptionDao（需要保存订阅到数据库）
```

**简单理解**：订阅管理器从服务器获取订阅的日历，然后保存到本地数据库。

### FestivalSubscriptionManager（节日订阅管理器）的依赖
```
FestivalSubscriptionManager → SharedPreferences（需要保存订阅状态）
```

**简单理解**：节日订阅管理器只需要保存用户的订阅状态（是否订阅某个节日）。

### HolidayManager（节假日管理器）的依赖
```
HolidayManager → CalendarApi（需要从服务器获取节假日数据）
HolidayManager → SharedPreferences（需要保存节假日设置）
```

**简单理解**：节假日管理器从服务器获取节假日信息，并保存用户的相关设置。

### WeatherManager（天气管理器）的依赖
```
WeatherManager → CalendarApi（需要从服务器获取天气数据）
```

**简单理解**：天气管理器通过API获取天气信息。

### FortuneManager（运势管理器）的依赖
```
FortuneManager → CalendarApi（需要从服务器获取运势数据）
```

**简单理解**：运势管理器通过API获取运势信息。

### AIAssistant（AI助手）的依赖
```
AIAssistant → CalendarApi（需要调用AI服务接口）
```

**简单理解**：AI助手通过API调用后端的AI服务。

### EventRepository（数据仓库）的依赖
```
EventRepository → EventDao（需要访问本地数据库）
EventRepository → CalendarApi（需要同步云端数据）
```

**简单理解**：数据仓库既可以从本地数据库读取，也可以从服务器同步数据。

## 💡 举个例子理解业务逻辑层

**场景一**：用户设置日程提醒

1. UI层调用 **ReminderManager** 设置提醒
2. ReminderManager 从 **EventDao** 读取日程信息（时间、标题等）
3. ReminderManager 调用系统的 **AlarmManager** 设置闹钟
4. 到了指定时间，系统触发提醒

**简单理解**：就像设置手机闹钟，你需要知道什么时候响（从数据库读取日程时间），然后告诉系统（AlarmManager）在那个时间提醒你。

**场景二**：用户订阅一个公开日历

1. UI层调用 **SubscriptionManager** 订阅日历
2. SubscriptionManager 通过 **CalendarApi** 从服务器获取该日历的所有日程
3. SubscriptionManager 通过 **SubscriptionDao** 把订阅信息保存到数据库
4. 以后这个日历的事件就会显示在用户的主界面

**简单理解**：就像订阅报纸，你去邮局（CalendarApi）订阅，邮局记录你的订阅信息（SubscriptionDao），以后每天都会收到报纸（日程数据）。

## 🎯 管理器的作用

每个管理器都是"单一职责"的：

- **ReminderManager**：只管提醒相关的事情
- **WeatherManager**：只管天气相关的事情
- **FortuneManager**：只管运势相关的事情

**简单理解**：每个部门主管只负责自己部门的事情，不会越界。

## 🔄 数据流向

```
UI层 → 管理器 → 数据访问/网络服务/系统服务 → 返回结果 → UI层
```

**简单理解**：用户的操作通过UI层传给管理器，管理器调用各种服务完成工作，然后把结果返回给UI层显示。

## 📊 管理器的分类

### 需要系统服务的管理器
- **ReminderManager**：需要 AlarmManager（闹钟）

### 需要网络服务的管理器
- **SubscriptionManager**：需要 CalendarApi
- **HolidayManager**：需要 CalendarApi
- **WeatherManager**：需要 CalendarApi
- **FortuneManager**：需要 CalendarApi
- **AIAssistant**：需要 CalendarApi

### 需要数据访问的管理器
- **ReminderManager**：需要 EventDao
- **SubscriptionManager**：需要 SubscriptionDao
- **EventRepository**：需要 EventDao

### 需要配置存储的管理器
- **FestivalSubscriptionManager**：需要 SharedPreferences
- **HolidayManager**：需要 SharedPreferences

## 📝 总结

这个图展示了业务逻辑层的组织结构：

- **管理器**：各个功能的主管（部门负责人）
- **数据访问**：提供数据支持（后勤部门）
- **网络服务**：提供网络通信（通信部门）
- **系统服务**：借用系统能力（外部资源）

就像公司的组织结构：
- 每个部门（管理器）负责一个功能
- 需要数据支持时找数据部门（数据访问）
- 需要和外界通信时找通信部门（网络服务）
- 需要系统功能时借用系统（系统服务）

它们各司其职，相互配合，共同完成各种业务逻辑！
