# ğŸ“¬ Ralendar API ç«¯ç‚¹è¯´æ˜ï¼ˆå›å¤ Roamio å›¢é˜Ÿï¼‰

> **å‘é€æ–¹**: Ralendar å›¢é˜Ÿ  
> **æ¥æ”¶æ–¹**: Roamio å›¢é˜Ÿ  
> **æ—¥æœŸ**: 2025-11-13  
> **ä¸»é¢˜**: å…³äº PUT /api/v1/fusion/events/{event_id}/ ç«¯ç‚¹çš„è¯´æ˜

---

## âœ… ç«¯ç‚¹å·²å®ç°å¹¶æ­£å¸¸å·¥ä½œ

ä½ å¥½ Roamio å›¢é˜Ÿï¼

æˆ‘ä»¬ç¡®è®¤ **PUT /api/v1/fusion/events/{event_id}/** ç«¯ç‚¹å·²ç»å®Œå…¨å®ç°ï¼Œå¹¶ä¸”ç»è¿‡ä»¥ä¸‹ä¼˜åŒ–ï¼š
- âœ… æ”¯æŒéƒ¨åˆ†æ›´æ–°ï¼ˆPATCH è¯­ä¹‰ï¼‰
- âœ… å®Œæ•´çš„å¼‚å¸¸å¤„ç†å’Œæ—¥å¿—è®°å½•
- âœ… ä¸‰å±‚ç”¨æˆ·åŒ¹é…ï¼ˆUnionID â†’ OpenID â†’ user_idï¼‰
- âœ… ä¿®å¤äº†åºåˆ—åŒ–å™¨çš„ `map_url` å­—æ®µå…è®¸ `null` çš„é—®é¢˜

---

## ğŸ“‹ å®Œæ•´ç«¯ç‚¹ä¿¡æ¯

### **åŸºæœ¬ä¿¡æ¯**
```
æ–¹æ³•ï¼šPUT
è·¯å¾„ï¼š/api/v1/fusion/events/{event_id}/
è®¤è¯ï¼šBearer Tokenï¼ˆæ¥è‡ª Roamioï¼‰
æƒé™ï¼šAllowAnyï¼ˆæ‰‹åŠ¨å¤„ç†ç”¨æˆ·åŒ¹é…ï¼‰
```

### **å®Œæ•´ URL**
```
https://app7626.acapp.acwing.com.cn/api/v1/fusion/events/{event_id}/
```

---

## ğŸ” è®¤è¯æœºåˆ¶

### **è¯·æ±‚å¤´ï¼ˆå¿…éœ€ï¼‰**
```http
Authorization: Bearer <roamio_jwt_token>
Content-Type: application/json
```

### **ç”¨æˆ·è¯†åˆ«ï¼ˆä¸‰å±‚åŒ¹é…ï¼‰**
ä¸ºäº†è·¨åº”ç”¨è¯†åˆ«ç”¨æˆ·ï¼Œæˆ‘ä»¬å®ç°äº†ä¸‰å±‚åŒ¹é…æœºåˆ¶ï¼š

**ä¼˜å…ˆçº§ 1ï¼šUnionIDï¼ˆæ¨èï¼‰**
```json
{
  "unionid": "UID_xxx...",
  "title": "æ›´æ–°åçš„æ ‡é¢˜"
}
```

**ä¼˜å…ˆçº§ 2ï¼šOpenIDï¼ˆå¤‡é€‰ï¼‰**
```json
{
  "openid": "xxx",
  "title": "æ›´æ–°åçš„æ ‡é¢˜"
}
```

**ä¼˜å…ˆçº§ 3ï¼šuser_idï¼ˆå…¼å®¹ï¼‰**
- ä» Token çš„ `user_id` å­—æ®µè‡ªåŠ¨æå–
- ä»…å½“ UnionID å’Œ OpenID éƒ½åŒ¹é…å¤±è´¥æ—¶ä½¿ç”¨

**ğŸ“Œ å¼ºçƒˆå»ºè®®**ï¼šåœ¨è¯·æ±‚ä½“ä¸­åŒ…å« `unionid` å­—æ®µï¼Œè¿™æ˜¯æœ€å¯é çš„æ–¹å¼ã€‚

---

## ğŸ“¤ è¯·æ±‚æ ¼å¼

### **æ”¯æŒçš„å­—æ®µï¼ˆæ‰€æœ‰å­—æ®µéƒ½æ˜¯å¯é€‰çš„ï¼‰**

#### **åŸºç¡€å­—æ®µ**
| å­—æ®µ | ç±»å‹ | å¿…å¡« | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|------|------|
| `title` | String | âŒ | äº‹ä»¶æ ‡é¢˜ | `"åŒ—äº¬äº”æ—¥æ¸¸ - Day 1"` |
| `description` | String | âŒ | äº‹ä»¶æè¿° | `"å‚è§‚æ•…å®«ï¼Œæ™šé¤å…¨èšå¾·"` |
| `start_time` | ISO 8601 | âŒ | å¼€å§‹æ—¶é—´ | `"2025-11-15T10:00:00+08:00"` |
| `end_time` | ISO 8601 | âŒ | ç»“æŸæ—¶é—´ | `"2025-11-15T12:00:00+08:00"` |
| `location` | String | âŒ | åœ°ç‚¹åç§° | `"åŒ—äº¬æ•…å®«åšç‰©é™¢"` |
| `reminder_minutes` | Integer | âŒ | æå‰æé†’ï¼ˆåˆ†é’Ÿï¼‰ | `30` |

#### **åœ°å›¾ä¿¡æ¯å­—æ®µ**
| å­—æ®µ | ç±»å‹ | å¿…å¡« | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|------|------|
| `latitude` | Float | âŒ | çº¬åº¦ï¼ˆ-90 åˆ° 90ï¼‰ | `39.9163` |
| `longitude` | Float | âŒ | ç»åº¦ï¼ˆ-180 åˆ° 180ï¼‰ | `116.3972` |
| `map_provider` | String | âŒ | åœ°å›¾æœåŠ¡å•† | `"baidu"`, `"amap"`, `"tencent"` |

**âš ï¸ æ³¨æ„**ï¼šç»çº¬åº¦å¿…é¡»åŒæ—¶æä¾›æˆ–åŒæ—¶ä¸ºç©ºã€‚

#### **æé†’é…ç½®å­—æ®µ**
| å­—æ®µ | ç±»å‹ | å¿…å¡« | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|------|------|
| `email_reminder` | Boolean | âŒ | æ˜¯å¦é‚®ä»¶æé†’ | `true` |

#### **æ¥æºè¿½è¸ªå­—æ®µ**
| å­—æ®µ | ç±»å‹ | å¿…å¡« | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|------|------|
| `source_app` | String | âŒ | æ¥æºåº”ç”¨ | `"roamio"` (è‡ªåŠ¨è®¾ç½®) |
| `source_id` | String | âŒ | æ¥æºå¯¹è±¡ ID | `"trip_123"` |
| `related_trip_slug` | String | âŒ | å…³è”æ—…è¡Œè®¡åˆ’ | `"beijing-trip-2025"` |

#### **ç”¨æˆ·è¯†åˆ«å­—æ®µï¼ˆæ¨èï¼‰**
| å­—æ®µ | ç±»å‹ | å¿…å¡« | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|------|------|
| `unionid` | String | ğŸ”¥ **å¼ºçƒˆæ¨è** | QQ UnionID | `"UID_xxx..."` |
| `openid` | String | âš ï¸ å¤‡é€‰ | QQ OpenID | `"xxx"` |

---

## ğŸ“¥ å“åº”æ ¼å¼

### **æˆåŠŸå“åº”ï¼ˆ200 OKï¼‰**
```json
{
  "id": 28,
  "title": "åŒ—äº¬äº”æ—¥æ¸¸ - Day 1: æ•…å®«å‚è§‚",
  "description": "ä¸Šåˆå‚è§‚æ•…å®«ï¼Œä¸‹åˆå‰å¾€å¤©å®‰é—¨å¹¿åœº",
  "start_time": "2025-11-15T10:00:00+08:00",
  "end_time": "2025-11-15T18:00:00+08:00",
  "location": "åŒ—äº¬æ•…å®«åšç‰©é™¢",
  "reminder_minutes": 30,
  "username": "å¼ ä¸‰",
  "created_at": "2025-11-10T12:00:00+08:00",
  "updated_at": "2025-11-13T15:30:00+08:00",
  
  "source_app": "roamio",
  "source_id": "trip_123",
  "related_trip_slug": "beijing-trip-2025",
  
  "latitude": 39.9163,
  "longitude": 116.3972,
  "map_provider": "baidu",
  "map_url": "https://api.map.baidu.com/marker?location=39.9163,116.3972&title=%E5%8C%97%E4%BA%AC...",
  "has_location": true,
  
  "email_reminder": true,
  "notification_sent": false,
  
  "is_from_roamio": true
}
```

### **åªè¯»å­—æ®µè¯´æ˜**
ä»¥ä¸‹å­—æ®µç”±æœåŠ¡å™¨è‡ªåŠ¨ç”Ÿæˆï¼Œä¸èƒ½é€šè¿‡ PUT ä¿®æ”¹ï¼š
- `id`: äº‹ä»¶ ID
- `username`: ç”¨æˆ·å
- `created_at`: åˆ›å»ºæ—¶é—´
- `updated_at`: æ›´æ–°æ—¶é—´ï¼ˆè‡ªåŠ¨æ›´æ–°ï¼‰
- `map_url`: åœ°å›¾é“¾æ¥ï¼ˆæ ¹æ®ç»çº¬åº¦è‡ªåŠ¨ç”Ÿæˆï¼‰
- `has_location`: æ˜¯å¦æœ‰åœ°ç†ä½ç½®ï¼ˆæ ¹æ®ç»çº¬åº¦è‡ªåŠ¨åˆ¤æ–­ï¼‰
- `is_from_roamio`: æ˜¯å¦æ¥è‡ª Roamioï¼ˆæ ¹æ® `source_app` è‡ªåŠ¨åˆ¤æ–­ï¼‰

---

## âŒ é”™è¯¯å“åº”

### **400 Bad Requestï¼ˆéªŒè¯å¤±è´¥ï¼‰**
```json
{
  "latitude": ["çº¬åº¦å¿…é¡»åœ¨ -90 åˆ° 90 ä¹‹é—´"],
  "longitude": ["ç»çº¬åº¦å¿…é¡»åŒæ—¶æä¾›æˆ–åŒæ—¶ä¸ºç©º"]
}
```

### **401 Unauthorizedï¼ˆè®¤è¯å¤±è´¥ï¼‰**
```json
{
  "error": "ç¼ºå°‘è®¤è¯ Token"
}
```
æˆ–
```json
{
  "error": "Token æ— æ•ˆ: Token is invalid or expired"
}
```

### **404 Not Foundï¼ˆäº‹ä»¶ä¸å­˜åœ¨æˆ–æ— æƒé™ï¼‰**
```json
{
  "error": "Event not found or no permission"
}
```

### **500 Internal Server Errorï¼ˆæœåŠ¡å™¨é”™è¯¯ï¼‰**
```json
{
  "error": "æ›´æ–°å¤±è´¥",
  "detail": "å…·ä½“é”™è¯¯ä¿¡æ¯"
}
```

**ğŸ“Œ æ³¨æ„**ï¼šæˆ‘ä»¬å·²ç»æ·»åŠ äº†è¯¦ç»†çš„æ—¥å¿—è®°å½•ï¼Œæ‰€æœ‰ 500 é”™è¯¯éƒ½ä¼šåœ¨æœåŠ¡å™¨æ—¥å¿—ä¸­è®°å½•å®Œæ•´çš„å †æ ˆä¿¡æ¯ã€‚

---

## ğŸ“ è¯·æ±‚ç¤ºä¾‹

### **ç¤ºä¾‹ 1ï¼šæ›´æ–°æ ‡é¢˜å’Œæ—¶é—´**
```bash
curl -X PUT https://app7626.acapp.acwing.com.cn/api/v1/fusion/events/28/ \
  -H "Authorization: Bearer <roamio_token>" \
  -H "Content-Type: application/json" \
  -d '{
    "unionid": "UID_xxx...",
    "title": "åŒ—äº¬äº”æ—¥æ¸¸ - Day 1: æ•…å®«æ·±åº¦æ¸¸",
    "start_time": "2025-11-15T09:00:00+08:00",
    "end_time": "2025-11-15T17:00:00+08:00"
  }'
```

### **ç¤ºä¾‹ 2ï¼šæ›´æ–°åœ°ç‚¹å’Œåæ ‡**
```bash
curl -X PUT https://app7626.acapp.acwing.com.cn/api/v1/fusion/events/28/ \
  -H "Authorization: Bearer <roamio_token>" \
  -H "Content-Type: application/json" \
  -d '{
    "unionid": "UID_xxx...",
    "location": "åŒ—äº¬å¤©å®‰é—¨å¹¿åœº",
    "latitude": 39.9042,
    "longitude": 116.4074,
    "map_provider": "amap"
  }'
```

### **ç¤ºä¾‹ 3ï¼šå¯ç”¨é‚®ä»¶æé†’**
```bash
curl -X PUT https://app7626.acapp.acwing.com.cn/api/v1/fusion/events/28/ \
  -H "Authorization: Bearer <roamio_token>" \
  -H "Content-Type: application/json" \
  -d '{
    "unionid": "UID_xxx...",
    "email_reminder": true,
    "reminder_minutes": 60
  }'
```

---

## ğŸ› å·²çŸ¥é—®é¢˜ä¿®å¤

### **å·²ä¿®å¤ï¼ˆ2025-11-13ï¼‰**
1. âœ… **map_url å­—æ®µ 500 é”™è¯¯**
   - **é—®é¢˜**ï¼š`map_url` å­—æ®µåœ¨ `allow_null=False` æ—¶ï¼Œè¿”å› `None` å¯¼è‡´åºåˆ—åŒ–å¤±è´¥
   - **ä¿®å¤**ï¼š`map_url = serializers.CharField(read_only=True, allow_null=True)`

2. âœ… **å¼‚å¸¸å¤„ç†ä¸å®Œå–„**
   - **é—®é¢˜**ï¼šPUT æ–¹æ³•ç¼ºå°‘ try-except å—ï¼Œé”™è¯¯ä¿¡æ¯ä¸æ¸…æ™°
   - **ä¿®å¤**ï¼šæ·»åŠ å®Œæ•´çš„å¼‚å¸¸å¤„ç†å’Œè¯¦ç»†æ—¥å¿—

3. âœ… **é‡æ–°åºåˆ—åŒ–é—®é¢˜**
   - **é—®é¢˜**ï¼šä¿å­˜åæœªé‡æ–°åºåˆ—åŒ–ï¼Œåªè¯»å­—æ®µå¯èƒ½ä¸å‡†ç¡®
   - **ä¿®å¤**ï¼šä¿å­˜åä½¿ç”¨ `EventSerializer(updated_event)` é‡æ–°åºåˆ—åŒ–

---

## ğŸ” è°ƒè¯•æ”¯æŒ

### **æœåŠ¡å™¨æ—¥å¿—ä½ç½®**
```bash
/tmp/uwsgi.log
```

### **æ—¥å¿—çº§åˆ«**
æˆ‘ä»¬åœ¨ PUT æ–¹æ³•ä¸­æ·»åŠ äº†ä»¥ä¸‹æ—¥å¿—ï¼š
- ğŸŸ¦ INFOï¼šè¯·æ±‚å¼€å§‹ã€æ•°æ®å†…å®¹ã€ä¿å­˜æˆåŠŸ
- ğŸŸ¥ ERRORï¼šéªŒè¯å¤±è´¥ã€å¼‚å¸¸è¯¦æƒ…ï¼ˆåŒ…å«å®Œæ•´å †æ ˆï¼‰

### **å®æ—¶æŸ¥çœ‹æ—¥å¿—**
```bash
tail -f /tmp/uwsgi.log | grep "Fusion API - PUT"
```

---

## ğŸš€ æµ‹è¯•å»ºè®®

### **æµ‹è¯•æ­¥éª¤**
1. **å‡†å¤‡å·¥ä½œ**
   ```bash
   # è·å– Roamio çš„ JWT Token
   export ROAMIO_TOKEN="your_roamio_jwt_token"
   
   # ç¡®ä¿ç”¨æˆ·å·²åœ¨ Ralendar ä¸­ç”¨ QQ ç™»å½•ï¼Œè·å– UnionID
   export UNIONID="UID_xxx..."
   ```

2. **è·å–äº‹ä»¶è¯¦æƒ…ï¼ˆéªŒè¯äº‹ä»¶å­˜åœ¨ï¼‰**
   ```bash
   curl -X GET https://app7626.acapp.acwing.com.cn/api/v1/fusion/events/28/ \
     -H "Authorization: Bearer $ROAMIO_TOKEN" \
     -H "Content-Type: application/json" \
     -d "{\"unionid\": \"$UNIONID\"}"
   ```

3. **æ›´æ–°äº‹ä»¶æ ‡é¢˜ï¼ˆæœ€å°æµ‹è¯•ï¼‰**
   ```bash
   curl -X PUT https://app7626.acapp.acwing.com.cn/api/v1/fusion/events/28/ \
     -H "Authorization: Bearer $ROAMIO_TOKEN" \
     -H "Content-Type: application/json" \
     -d "{\"unionid\": \"$UNIONID\", \"title\": \"æµ‹è¯•æ›´æ–°\"}"
   ```

4. **éªŒè¯æ›´æ–°ç»“æœ**
   - æ£€æŸ¥å“åº”ä¸­çš„ `updated_at` å­—æ®µæ˜¯å¦æ›´æ–°
   - æ£€æŸ¥ `title` æ˜¯å¦å·²å˜æ›´
   - æŸ¥çœ‹æ—¥å¿—ç¡®è®¤æ²¡æœ‰é”™è¯¯

---

## ğŸ“ è”ç³»æ–¹å¼

å¦‚æœåœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­é‡åˆ°ä»»ä½•é—®é¢˜ï¼Œè¯·ï¼š

1. **æŸ¥çœ‹æ—¥å¿—**ï¼š`tail -f /tmp/uwsgi.log`
2. **æä¾›ä»¥ä¸‹ä¿¡æ¯**ï¼š
   - è¯·æ±‚çš„å®Œæ•´ URL
   - è¯·æ±‚ä½“å†…å®¹ï¼ˆéšè—æ•æ„Ÿä¿¡æ¯ï¼‰
   - å“åº”çŠ¶æ€ç å’Œå“åº”ä½“
   - æœåŠ¡å™¨æ—¥å¿—ä¸­çš„ç›¸å…³é”™è¯¯ï¼ˆå¸¦æ—¶é—´æˆ³ï¼‰

3. **åé¦ˆæ¸ é“**ï¼š
   - åˆ›å»º GitHub Issue
   - åœ¨é¡¹ç›®æ–‡æ¡£ä¸­è¡¥å……

---

## ğŸ“‹ æ£€æŸ¥æ¸…å•

åœ¨é›†æˆå‰ï¼Œè¯·ç¡®ä¿ï¼š

- [ ] ç”¨æˆ·å·²åœ¨ Ralendar ä¸­ç”¨ QQ ç™»å½•
- [ ] å¯ä»¥è·å–åˆ°ç”¨æˆ·çš„ UnionID
- [ ] Roamio Token åœ¨ Ralendar æœåŠ¡å™¨ä¸Šå¯éªŒè¯
- [ ] äº‹ä»¶ ID å­˜åœ¨ä¸”å±äºå½“å‰ç”¨æˆ·
- [ ] è¯·æ±‚ä½“åŒ…å« `unionid` å­—æ®µ
- [ ] æ—¶é—´æ ¼å¼ä¸º ISO 8601ï¼ˆå¸¦æ—¶åŒºï¼‰
- [ ] ç»çº¬åº¦åœ¨æœ‰æ•ˆèŒƒå›´å†…ï¼ˆå¦‚æœæä¾›ï¼‰

---

## âœ… æ€»ç»“

- **ç«¯ç‚¹çŠ¶æ€**ï¼šâœ… å·²å®ç°å¹¶ç¨³å®šè¿è¡Œ
- **æ¨èåšæ³•**ï¼šåœ¨æ¯ä¸ªè¯·æ±‚ä¸­åŒ…å« `unionid` å­—æ®µ
- **æ—¶é—´æ ¼å¼**ï¼šISO 8601 with timezoneï¼ˆ`YYYY-MM-DDTHH:MM:SS+08:00`ï¼‰
- **é”™è¯¯å¤„ç†**ï¼šå®Œæ•´çš„æ—¥å¿—è®°å½•å’Œå‹å¥½çš„é”™è¯¯ä¿¡æ¯
- **æ€§èƒ½**ï¼šå•æ¬¡è¯·æ±‚ < 500msï¼ˆå«æ•°æ®åº“æŸ¥è¯¢å’Œåºåˆ—åŒ–ï¼‰

å¦‚æœ‰ä»»ä½•ç–‘é—®ï¼Œæ¬¢è¿éšæ—¶è”ç³»ï¼ğŸ‰

---

**Ralendar å¼€å‘å›¢é˜Ÿ**  
*2025-11-13*

