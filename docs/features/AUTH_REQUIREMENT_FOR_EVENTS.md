# 📝 日程功能登录限制说明

> **更新日期**: 2025-11-09  
> **状态**: ✅ 已实现

---

## 🎯 功能概述

为了保护用户隐私和数据安全，从本次更新开始，**日程相关功能需要登录后才能使用**。

未登录用户仍可访问日历页面并查看公共功能（今日运势、今日节日），但无法创建、查看、编辑或删除个人日程。

---

## 📊 功能权限对比

| 功能 | 未登录用户 | 登录用户 |
|------|-----------|---------|
| **查看日历** | ✅ 可以 | ✅ 可以 |
| **查看今日运势** | ✅ 可以 | ✅ 可以 |
| **查看今日节日** | ✅ 可以 | ✅ 可以 |
| **查看日程列表** | ❌ 不可见 | ✅ 可以 |
| **创建事件** | ❌ 不可以 | ✅ 可以 |
| **编辑事件** | ❌ 不可以 | ✅ 可以 |
| **删除事件** | ❌ 不可以 | ✅ 可以 |
| **点击日期查看日程** | ❌ 提示登录 | ✅ 可以 |
| **点击事件查看详情** | ❌ 提示登录 | ✅ 可以 |

---

## 🔒 受限功能详情

### **1. 侧边栏标签页**

#### **未登录状态**:
- 只显示 2 个标签页：
  - ⭐ 今日运势
  - 🎉 今日节日
- 不显示"📅 日程列表"标签

#### **登录后**:
- 显示 3 个标签页：
  - 📅 日程列表（排在第一位）
  - ⭐ 今日运势
  - 🎉 今日节日

---

### **2. 浮动操作按钮**

#### **未登录状态**:
- 显示"登录"按钮（右下角浮动按钮）
- 点击后跳转到登录页面

#### **登录后**:
- 显示"+"按钮（创建事件）
- 点击后打开事件创建对话框

---

### **3. 工具栏**

#### **未登录状态**:
- 不显示桌面端工具栏（包括"添加事件"等按钮）

#### **登录后**:
- 显示完整工具栏
- 包括"添加事件"、"刷新"等功能

---

### **4. 事件加载**

#### **未登录状态**:
- 不从后端加载用户事件
- 日历上不显示任何个人日程
- 仍会加载节日数据（公共数据）

#### **登录后**:
- 自动加载用户的所有事件
- 日历上显示事件圆点指示器
- 可以点击日期查看当天的日程

---

### **5. 交互限制**

当未登录用户尝试以下操作时，会弹出提示并引导登录：

| 操作 | 提示内容 | 跳转 |
|------|---------|------|
| 点击日期 | "查看日程需要登录，请先登录" | 登录页 |
| 点击事件 | "查看事件详情需要登录，请先登录" | 登录页 |
| 点击添加按钮 | "创建事件需要登录，请先登录" | 登录页 |

**提示样式**: Element Plus 的 warning 消息框，持续 3 秒，然后自动跳转到登录页。

---

## 💻 技术实现

### **1. 登录状态检测**

```javascript
// 检查 localStorage 中的 access_token
const isLoggedIn = ref(false)
const checkLoginStatus = () => {
  const token = localStorage.getItem('access_token')
  isLoggedIn.value = !!token
  return isLoggedIn.value
}
```

### **2. 条件渲染**

```vue
<!-- 工具栏：仅登录后显示 -->
<div v-if="isLoggedIn" class="toolbar">
  <Toolbar @add="openAddDialog" />
</div>

<!-- 浮动按钮：根据登录状态切换 -->
<button v-if="isLoggedIn" class="floating-add-btn">
  <i class="bi bi-plus-lg"></i>
</button>
<button v-else class="floating-login-btn" @click="router.push('/login')">
  <i class="bi bi-box-arrow-in-right"></i>
  <span>登录</span>
</button>
```

### **3. 动态标签页**

```javascript
// useSidebarTabs.js
export function useSidebarTabs(initialTab = 'events', isLoggedIn = false) {
  const tabs = computed(() => {
    const baseTabs = [
      { id: 'fortune', label: '今日运势', icon: 'bi-stars' },
      { id: 'holiday', label: '今日节日', icon: 'bi-calendar-heart' }
    ]
    
    // 只有登录后才显示日程列表
    if (isLoggedIn) {
      return [
        { id: 'events', label: '日程列表', icon: 'bi-calendar-check' },
        ...baseTabs
      ]
    }
    
    return baseTabs
  })
  
  return { activeTab, tabs }
}
```

### **4. 权限拦截**

```javascript
// 未登录提示并跳转
const requireLogin = (action = '该操作') => {
  ElMessage.warning({
    message: `${action}需要登录，请先登录`,
    duration: 3000
  })
  setTimeout(() => {
    router.push({ name: 'login', query: { redirect: '/calendar' } })
  }, 500)
  return false
}

// 日期点击事件
const handleDateSelected = (dateStr) => {
  if (!checkLoginStatus()) {
    requireLogin('查看日程')
    return
  }
  // ... 继续执行
}
```

### **5. 条件加载**

```javascript
onMounted(async () => {
  checkLoginStatus()
  await loadHolidays()
  await loadTodayHolidays()
  
  // 只有登录后才加载用户事件
  if (isLoggedIn.value) {
    await loadEvents()
  }
})
```

---

## 🎨 UI/UX 设计

### **未登录状态的引导**

#### **浮动登录按钮**:
- 位置：右下角固定悬浮
- 样式：渐变紫色背景 + 登录图标 + "登录"文字
- 动画：悬停时向上移动
- 尺寸：
  - 桌面端：60px 高度，自适应宽度
  - 移动端：50px 高度，自适应宽度

#### **提示消息**:
- 类型：Element Plus `ElMessage.warning`
- 内容：明确说明需要登录的原因
- 持续：3 秒
- 行为：自动跳转到登录页，并保留 `redirect` 参数

---

## 📱 移动端适配

所有登录限制在移动端同样生效：

1. **标签页切换**: 未登录时只显示运势和节日
2. **浮动按钮**: 未登录显示登录按钮，登录后显示添加按钮
3. **工具栏**: 移动端不显示工具栏（无论是否登录）
4. **提示消息**: 使用 Element Plus 的响应式消息框

---

## 🔐 安全考虑

### **前端限制**:
- ✅ 隐藏 UI 元素（按钮、标签页）
- ✅ 拦截用户操作（点击事件）
- ✅ 不加载用户数据

### **后端保护**:
- ✅ 所有事件 API 需要 JWT Token 认证
- ✅ 用户只能访问自己的事件
- ✅ Token 验证失败返回 401

**注意**: 前端限制主要用于提升用户体验，真正的安全保护由后端 API 提供。

---

## 🧪 测试场景

### **测试 1: 未登录用户访问日历**
1. 打开浏览器无痕模式
2. 访问 `https://app7626.acapp.acwing.com.cn/calendar`
3. **预期**:
   - ✅ 能看到日历
   - ✅ 能看到"今日运势"和"今日节日"标签
   - ❌ 看不到"日程列表"标签
   - ✅ 右下角显示"登录"按钮
   - ❌ 日历上没有事件圆点

### **测试 2: 未登录用户尝试创建事件**
1. 未登录状态下
2. 点击右下角"登录"按钮
3. **预期**:
   - ✅ 跳转到登录页
   - ✅ URL 包含 `?redirect=/calendar`

### **测试 3: 未登录用户尝试查看日程**
1. 未登录状态下
2. 点击日历上的某个日期
3. **预期**:
   - ✅ 弹出提示："查看日程需要登录，请先登录"
   - ✅ 3 秒后跳转到登录页

### **测试 4: 登录后功能恢复**
1. 登录账号
2. 返回日历页
3. **预期**:
   - ✅ 看到"日程列表"标签（排第一位）
   - ✅ 右下角显示"+"按钮
   - ✅ 桌面端显示工具栏
   - ✅ 日历上显示事件圆点
   - ✅ 能创建、查看、编辑、删除事件

### **测试 5: 登录状态持久化**
1. 登录后刷新页面
2. **预期**:
   - ✅ 仍保持登录状态
   - ✅ 所有功能正常

### **测试 6: 退出登录后状态重置**
1. 点击用户头像 → 退出登录
2. **预期**:
   - ✅ 跳转到登录页
   - ✅ 清除 localStorage 中的 token
   - ✅ 返回日历页后恢复未登录状态

---

## 📂 修改文件清单

### **新增/修改**:
- `web_frontend/src/composables/useSidebarTabs.js` - 添加登录状态参数
- `web_frontend/src/views/CalendarView.vue` - 主要逻辑修改
- `docs/features/AUTH_REQUIREMENT_FOR_EVENTS.md` - 本文档

### **核心修改点**:
1. 添加 `isLoggedIn` 状态检测
2. 添加 `requireLogin` 提示函数
3. 修改侧边栏标签页生成逻辑
4. 添加条件渲染指令（`v-if="isLoggedIn"`）
5. 修改事件加载逻辑（仅登录后加载）
6. 添加未登录引导按钮样式
7. 在关键操作前添加登录检查

---

## 🎯 用户体验优化

### **✅ 优点**:
1. **清晰的权限提示**: 用户知道哪些功能需要登录
2. **友好的引导**: 浮动登录按钮引导用户登录
3. **保留访问能力**: 未登录用户仍可查看公共功能
4. **无缝跳转**: 登录后自动返回原页面

### **❌ 避免的问题**:
1. ~~直接跳转到登录页~~（破坏用户浏览体验）
2. ~~显示空白页面~~（让用户困惑）
3. ~~允许未登录用户创建事件~~（数据安全问题）
4. ~~不给提示就禁用功能~~（用户不知道为什么）

---

## 🔄 与其他功能的关系

### **与 AcWing 端的区别**:
- **Web 端**: 严格的登录限制（本次更新）
- **AcWing 端**: 自动登录，无需额外登录流程

### **与 Roamio 集成**:
- Roamio 用户通过 QQ UnionID 识别
- 同样需要登录才能同步日程到 Ralendar
- 使用相同的 JWT Token 验证

---

## 📅 更新历史

| 日期 | 版本 | 更新内容 |
|------|------|---------|
| 2025-11-09 | 1.0 | 初始版本：实现日程功能登录限制 |

---

## 📞 反馈与支持

如果在使用过程中遇到问题，请联系：
- **开发者**: ppshuX
- **QQ**: 2064747320
- **邮箱**: 2064747320@qq.com

---

**Ralendar 团队**  
**2025-11-09**

